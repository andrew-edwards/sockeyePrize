---
title: "Bristol Bay 2025 - wrangling and saving covariates"
author: "Andrew Edwards and Carrie Holt"
output: pdf_document
fontsize: 12pt
date: "Last compiled on `r format(Sys.time(), '%d %B, %Y')`"
---

```{r, setup, include = FALSE, cache = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "",
  cache = TRUE,
  cache_path = "bristol-bay-coovariates-cache/",
  fig.path = "bristol-bay-coovariates-cache/",
  fig.width = 7,
  fig.height = 6
)

knitr::dep_prev()
```

```{r, build, echo = FALSE, eval = FALSE}
# To build either run this line or click knit button in RStudio:
rmarkdown::render("bristol-bay-covariates.Rmd")
```

```{r, packages, echo = FALSE, cache = FALSE}
load_all()
# Or:
# remotes::install_github("andrew-edwards/sockeyePrize")
# library(sockeyePrize)
library(dplyr)
library(pbsEDM)
library(pacea)    # make sure to update
library(gridExtra)
library(ggplot2)

# From Chris's hake
f <- function(x, digits = 0){

  if(is.null(x)){
    return(x)
  }

  format(round(x,
               digits),
         big.mark = ",",
         nsmall = digits)
}

```

```{r, system}
system <- "Bristol Bay"
```

Working out the Bristol Bay stock-independent covariates, using `analysis-2025-3.Rmd` as a
template in which I did the Fraser River ones (plus some analyses, but keep
the analyses separate now). See that for more details and explanations than I'm
including here.

Then do each stock and age class separately, just extracting the returns. Don't
have effective spawners for non-Fraser River, plus don't need to use brood data
either. Here just skip all that and do the shared covariates.

`Juveniles_Marine_Entry` is sum of other columns in something, and I had this:

Bristol Bay: all separate 1.2, 1.3, 2.2 and 2.3. Based on what they
recommend.

But didn't use for Fraser River, not going to for others either.

# Bristol Bay

What we would put into pbsEDM.

Try to predict (doing these in the stock-specific analyses each time):

- AgeClass_1.2 returns each year, say 2021 as an example. From `returns_all`.

- AgeClass_1.3 returns each year, (2021), an additional covariate would be AgeClass_1.2 returns.

- AgeClass_2.2 returns each year, (2021).

- AgeClass_2.3 returns each year, (2021), an additional covariate would be AgeClass_2.2 returns

Do each separately and then give the sum as the total prediction.

Covariates would be:

Not doing.  at-sea total abundances in year of outmigration (2019), two years prior to
  return, for AgeClass_1.2 and AgeClass_2.2. Think these were what we were
  confused about before.

Not doing. at-sea total abundances in year of outmigration (2018), three year prior to the return year for AgeClass_1.3 and AgeClass_2.3.

D PDO in year of outmigration (May-August 2019), two years prior to return, for AgeClass_1.2 and AgeClass_2.2.

D PDO in year of outmigration (May-August 2018), three years prior to return, for AgeClass_1.3 and AgeClass_2.3.

D from "total_np_salmon.csv", total pink salmon abundance in N Pacific returning the same return year as being predicted (2021), to predict AgeClass_1.2 and AgeClass_2.2 returns

D total pink salmon abundance in N Pacific returning the year prior to the year being predicted (2020), to predict AgeClass_1.3 and AgeClass_2.3 returns (an alternative hypothesis is that pink salmon in the same return year as being predicted could be used for these age classes as well)

Not doing. from "total_np_salmon.csv", total salmon abundance in N Pacific returning the same return year as being predicted (2021), to predict AgeClass_1.2 and AgeClass_2.2 returns

Not doing. total salmon abundance in N Pacific returning the year prior to the year being predicted (2020), to predict AgeClass_1.3 and AgeClass_2.3 returns (an alternative hypothesis is that salmon in the same return year as being predicted could be used for these age classes as well)

- additional covariates for which we currently do not have data (no time to get these):

- Median Bristol Bay Sea Level Pressure between May–August in year cohort entered ocean (source: ERDDAP ICOADS)

- Median Bristol Bay SST between May–August in year cohort entered ocean (source: ERDDAP HadISST)

- Median Bristol Bay wind stress between May–August in year cohort entered ocean (source: ERDDAP ICOADS)

<!-- Columbia River - copy back in from analysis-2025-3.Rmd -->


## Check the returns so we know what years we need

But then do the required values in stock-specific analyses, as just filtering and
selecting.

```{r, returnssystem}
returns_system <- filter(returns_all,
                         System == system)
returns_system

system_first_year <- min(returns_system$ReturnYear)
system_first_year
```

Then join everything in one go at the end (rather than build up like I'd done
previously), and start a few years before `system_first_year`.

## PDO in summer

PDO in the summer of outmigration (May-August).

```{r pdo}
summer_months <- 5:8
pdo_summer_months <- filter(pdo, month %in% summer_months)
stopifnot(pull(pdo_summer_months[1, "month"]) == min(summer_months))  # check first
                                        # year is full

pdo_summer <- summarise(group_by(pdo_summer_months,
                                 year),
                        pdo_summer_mean = mean(anomaly)) %>%
  ungroup()

pdo_summer

pdo_summer %>% tail()
```

## At-sea abundances

Can just take values from `fraser_covariates`:
```{r, atsea}
at_sea_pink <- select(fraser_covariates,
                      year,
                      pink)
at_sea_pink
```
## Combine covariates

Start with PDO as goes way back. Start from 5 years before first year of returns.
```{r, covar}
system_first_year
combine <- filter(pdo_summer,
                  year >= system_first_year - 5)
bristol_bay_covariates <- left_join(combine,
                                    at_sea_pink)
bristol_bay_covariates
bristol_bay_covariates %>% tail()
```

## Plot covariates - look at correlations of non-stock specific ones

Only two now though.

```{r plotcovariates, fig.height = 9}
to_plot <- tidyr::pivot_longer(bristol_bay_covariates,
                               cols = -year) %>%
  mutate(name = factor(name))

p <- ggplot(to_plot,
            aes(year, value)) +
  geom_path() +                        # leaves gaps for NA's, but none now
  # facet_wrap(~name, scales = "free_y")
  facet_grid(name ~ ., scales = "free_y")

p

# It reorders them alphabetically; need something like this:
#  mutate(name = factor(name, levels = paste0("X", 1:12))) %>%
```

Full correlation plot
```{r corrplot}
# pairs(bristol_bay_covariates,
#      lower.panel = panel.cor)
GGally::ggpairs(bristol_bay_covariates)
```

A clearer plot (coefficients are calculated slightly differently):
```{r, fullspan3}
corrplot::corrplot(cor(bristol_bay_covariates,
                       use = "pairwise.complete.obs"),
  method = "number",
  type = "upper" # show only upper side
  )
```

So fine to use PDO and pinks.

```{r, savecovariates}
bristol_bay_covariates

usethis::use_data(bristol_bay_covariates,
                  overwrite = TRUE)
```
