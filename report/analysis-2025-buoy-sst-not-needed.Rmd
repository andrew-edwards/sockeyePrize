---
title: "The buoy SST calculations that we no longer need as going to use OISST"
author: "Andrew Edwards and Carrie Holt"
output: pdf_document
fontsize: 12pt
date: "Last compiled on `r format(Sys.time(), '%d %B, %Y')`"
---

```{r, setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "",
  cache = TRUE,
  cache_path = "analysis-2025-buoy-sst-not-needed-cache/",
  fig.path = "analysis-2025-buoy-sst-not-needed-figs-cache/",
  fig.width = 7,
  fig.height = 6
)
  # comment = "#>",
```

```{r, build, echo = FALSE, eval = FALSE}
# To build either run this line or click knit button in RStudio:
rmarkdown::render("analysis-2025-buoy-sst-not-needed.Rmd")
```

```{r, packages, echo = FALSE, cache = FALSE}
load_all()
# Or:
# remotes::install_github("andrew-edwards/sockeyePrize")
# library(sockeyePrize)
library(dplyr)
library(pbsEDM)
library(pacea)    # make sure to update
library(gridExtra)
```

Moving the buoy SST code to here (from `analysis-2025.Rmd`) as no longer need it
since going to use OISST, but want to move it out of the way yet keep it to
maybe use elsewhere. In particular has plotting of each year (for just threem
months) to check for gaps, which is hard to automate; need to manually inspect.


### Buoy temperatures

- Temperature from buoys: "Halibut Bank" (Apr-Jun average), "West Sea Otter" (Apr-Jul average), "East Dellwood Knolls" (Apr-Jul average). Year of
 outmigration, after the PDO Mar calculation.

Adapting from the pacea buoys vignette:

```{r buoys}
buoy_names <- c("Halibut Bank",
                "West Sea Otter",
                "East Dellwood Knolls") # This is their order in the data it seems

buoys <- filter(buoy_metadata,
                name %in% buoy_names)
buoys   # shows we have SST for quite different depths

buoy_temps <- filter(buoy_sst,
                     stn_id %in% buoys$stn_id)

buoy_ranges <- buoy_temps %>%
  group_by(stn_id) %>%
  summarise(start = min(date),
            end = max(date))
buoy_ranges   # looks good
```

### Buoy 1

Do each buoy separately, since slightly different time spans, and need to
manually check data.
```{r buoys1}
i_buoy <- 1
id <- buoy_ranges$stn_id[i_buoy]
id
filter(buoy_metadata, stn_id == id)$name

buoy_sst_1 <- filter(buoy_sst,
                     stn_id == id,
                     lubridate::month(date) %in% c(4, 5, 6))  # Apr-Jun

plot(buoy_sst_1,
     stn_id = id)
```

That figure doesn't show any obvious outliers that need looking into.

```{r buoys1a}
plot(buoy_sst_1$date,
     buoy_sst_1$sst)
```
That does show 2023 looks a bit odd, maybe short on data:
```{r buoys1b}
plot(buoy_sst_1,
     stn_id = id,
     year_highlight = 2023)
```
As suggested, not a complete time series so need to exclude.

Look more systematically, first removing the rows with NA's.

```{r buoys1c}
buoy_sst_1 <- filter(buoy_sst_1,
                     !is.na(sst))

buoy_sst_1_mean <- summarise(group_by(buoy_sst_1,
                                      year = lubridate::year(date)),
                             num_days = n(),
                             sst_average = mean(sst))
buoy_sst_1_mean %>% a()
sort(buoy_sst_1_mean$num_days)
```
So there should be maximum of 91 days of SST from Apr-Jun. Need to check if
missing values are random or systematic.

```{r buoys1d}
buoy_sst_1_mean %>% a()
sort(buoy_sst_1_mean$num_days)
```

Agh, 2023 is the year we will need, and that's problematic for this buoy. So
maybe look for another nearby buoy. Could look how well correlated this one is
to other close ones. TODO.

But first try the second of our originally planned buoys.

### Buoy 2

Do each buoy separately, since slightly different time spans, and need to
manually check data.
```{r buoys2}
i_buoy <- 2
id <- buoy_ranges$stn_id[i_buoy]
id
filter(buoy_metadata, stn_id == id)$name

buoy_sst_2 <- filter(buoy_sst,
                     stn_id == id,
                     lubridate::month(date) %in% c(4, 5, 6, 7))  # Apr-Jul

plot(buoy_sst_2,
     stn_id = id)
```

That figure doesn't show any obvious outliers that need looking into, except
maybe that one in the middle. TODO see if the following highlights it.

```{r buoys2a}
plot(buoy_sst_2$date,
     buoy_sst_2$sst)
```
That does show 2013 missing, 1994 short on data probably:
```{r buoys2b}
plot(buoy_sst_2,
     stn_id = id,
     year_highlight = 1994)
```
As suggested, not a complete time series so need to exclude.

Look more systematically, first removing the rows with NA's for this, but need
to keep them in for the plotting.

```{r buoys2c}
buoy_sst_2_mean <- summarise(group_by(filter(buoy_sst_2,
                                             !is.na(sst)),
                                      year = lubridate::year(date)),
                             num_days = n(),
                             sst_average = mean(sst))
buoy_sst_2_mean %>% a()
sort(buoy_sst_2_mean$num_days)
```
So there should be maximum of 122 days of SST from Apr-Jun. Need to check if
missing values are random or systematic.

```{r buoys2d}
buoy_sst_2_mean %>% a()
sort(buoy_sst_2_mean$num_days)

plot(buoy_sst_2_mean$year,
     buoy_sst_2_mean$sst_average,
     type = "o",
     main = "Before removing low counts")
```

Think just have to look at potentially problematic years in turn. Making plots
in groups of 8 years, then after list the ones to keep/exclude.

```{r buoys2e}
# par(mfrow = c(8, 4))   # Don't need to do 2025
buoy_sst_2_plots <- list()
for(i_year in 1:32){
  year_val <- buoy_sst_2_mean$year[i_year]
  # buoy_sst_2_plot_names[[i_year]] <- paste0("buoy_sst_2_plot_",
  #                                        year_val)
  #assign(paste0("buoy_sst_2_plot_",
  #              year_val),
  buoy_sst_2_plots[[i_year]] <-
    plot(buoy_sst_2,
         stn_id = id,
         years = year_val,
         year_highlight = NA, #year_val,
         title = year_val)
  # %>% ggplot2::ggplotGrob()
}

plt <- cowplot::plot_grid(plotlist = buoy_sst_2_plots[1:8],
                   ncol = 2,
                   nrow = 4)
```

```{r buoys2ebigplot, fig.width = 8, fig.height = 10}
plt
# If want to add global axis labels:
#y_grob <- textGrob("Depth (m)",
#                     gp = gpar(fontsize = label_size),
#                     rot = 90)
#  x_grob <- textGrob("Year",
#                     gp = gpar(fontsize = label_size),
#                     vjust = -0.5)
# grid.arrange(arrangeGrob(plt)) # , left = y_grob, bottom = x_grob))
```

```{r buoys2ebigplot2, fig.width = 8, fig.height = 10}
cowplot::plot_grid(plotlist = buoy_sst_2_plots[9:16],
                   ncol = 2,
                   nrow = 4)
```

```{r buoys2ebigplot3, fig.width = 8, fig.height = 10}
cowplot::plot_grid(plotlist = buoy_sst_2_plots[17:24],
                   ncol = 2,
                   nrow = 4)
```

```{r buoys2ebigplot4, fig.width = 8, fig.height = 10}
cowplot::plot_grid(plotlist = buoy_sst_2_plots[25:32],
                   ncol = 2,
                   nrow = 4)
```

Now document the years to keep for this buoy. Just visually look at figures and
keep those without any 'large gaps' in one
area; or rather, small gaps are okay if they are spread out. Quick for now, a
little subjective, can make more explicitly later if needed. Also, looks like
analysis will start with `return_year = 1998` anyway, which lessens the impact
of removing some of these early years.
```{r buoys2keep}
buoy_sst_2_years_to_keep <- c(1991,
                              1996,
                              1999,
                              2000,
                              2002:2018,
                              2020:2021,
                              2023)

buoy_sst_2_mean_keep <- filter(buoy_sst_2_mean,
                               year %in% buoy_sst_2_years_to_keep)
buoy_sst_2_mean_not_keep <- filter(buoy_sst_2_mean,
                                   !(year %in% buoy_sst_2_years_to_keep))

# Keeping these:
buoy_sst_2_mean_keep %>% a()

# Not keeping these:
buoy_sst_2_mean_not_keep %>% a()

plot(buoy_sst_2_mean$year,
     buoy_sst_2_mean$sst_average,
     type = "o",
     main = "Black - all; red - years keeping")

points(buoy_sst_2_mean_keep$year,
       buoy_sst_2_mean_keep$sst_average,
       type = "o",
       col = "red")
```
Shows that you can't simply just have a cut off based on `num_days`.

To add to the EDM input file, but also filling in some missing years from 1998 onwards. Just doing means of
adjacent years (or 1996 and 1999 for 1998) as a simple fix. Only needed for four
years:

```{r buoy2keep}
buoy_sst_2_mean_keep

buoy_sst_otter_input <-
  rename(buoy_sst_2_mean_keep,
         buoy_sst_otter = sst_average) %>%
  mutate(return_year = year + 2)

buoy_sst_otter_input
tail(buoy_sst_otter_input)

# Keeping the pre-1998 return years in here as they'll get removed later anyway,
# but manually filling in adjacent-mean values for return_year's of
# filter(input_age4, is.na(buoy_sst_otter), return_year >= 1998)$return_year  #
# (before fixing the NA's)
# 1999 2000 2003 2015 2016 2021 2024
# Could do something more fancier like look at
# correlations with similar years, but this is quicker.

# NOT DONE YET HERE HERE.

```

\clearpage

### Buoy 3

Using Buoy 2 above as a template for all this.

Do each buoy separately, since slightly different time spans, and need to
manually check data.
```{r buoys3}
i_buoy <- 3
id <- buoy_ranges$stn_id[i_buoy]
id
filter(buoy_metadata, stn_id == id)$name

buoy_sst_3 <- filter(buoy_sst,
                     stn_id == id,
                     lubridate::month(date) %in% c(4, 5, 6, 7))  # Apr-Jul

plot(buoy_sst_3,
     stn_id = id)
```

That figure doesn't show any obvious outliers that need looking into, except
maybe that one in the middle.

```{r buoys3a}
plot(buoy_sst_3$date,
     buoy_sst_3$sst)
```
That does show 2023 missing, which, annoyingly, is going to be the one we want
for the projection.
```{r buoys3b}
plot(buoy_sst_3,
     stn_id = id,
     year_highlight = 2023)
```
As suggested, not a complete time series so need to exclude.

Look more systematically, first removing the rows with NA's for this, but need
to keep them in for the plotting.

```{r buoys3c}
buoy_sst_3_mean <- summarise(group_by(filter(buoy_sst_3,
                                             !is.na(sst)),
                                      year = lubridate::year(date)),
                             num_days = n(),
                             sst_average = mean(sst))
buoy_sst_3_mean %>% a()
sort(buoy_sst_3_mean$num_days)
```
So there should be maximum of 122 days of SST from Apr-Jun. Need to check if
missing values are random or systematic.

Agh - 2023 is completely missing (as is 2024). So this won't be of any
use. Keeping the remaining code chunks (as already changed everything to '3'), but not running them.

```{r buoys3d, echo = FALSE, eval = FALSE}
buoy_sst_3_mean %>% a()
sort(buoy_sst_3_mean$num_days)

plot(buoy_sst_3_mean$year,
     buoy_sst_3_mean$sst_average,
     type = "o",
     main = "Before removing low counts")
```

Think just have to look at potentially problematic years in turn. Making plots
in groups of 8 years, then after list the ones to keep/exclude.

```{r buoys3e, echo = FALSE, eval = FALSE}
buoy_sst_3_plots <- list()
for(i_year in 1:32){
  year_val <- buoy_sst_3_mean$year[i_year]
  buoy_sst_3_plots[[i_year]] <-
    plot(buoy_sst_3,
         stn_id = id,
         years = year_val,
         year_highlight = NA, #year_val,
         title = year_val)
}

plt <- cowplot::plot_grid(plotlist = buoy_sst_3_plots[1:8],
                   ncol = 2,
                   nrow = 4)
```

```{r buoys3ebigplot, fig.width = 8, fig.height = 10, echo = FALSE, eval = FALSE}
plt
# If want to add global axis labels:
#y_grob <- textGrob("Depth (m)",
#                     gp = gpar(fontsize = label_size),
#                     rot = 90)
#  x_grob <- textGrob("Year",
#                     gp = gpar(fontsize = label_size),
#                     vjust = -0.5)
# grid.arrange(arrangeGrob(plt)) # , left = y_grob, bottom = x_grob))
```

```{r buoys3ebigplot2, fig.width = 8, fig.height = 10, echo = FALSE, eval = FALSE}
cowplot::plot_grid(plotlist = buoy_sst_3_plots[9:16],
                   ncol = 2,
                   nrow = 4)
```

```{r buoys3ebigplot3, fig.width = 8, fig.height = 10, echo = FALSE, eval = FALSE}
cowplot::plot_grid(plotlist = buoy_sst_3_plots[17:24],
                   ncol = 2,
                   nrow = 4)
```

```{r buoys3ebigplot4, fig.width = 8, fig.height = 10, echo = FALSE, eval = FALSE}
cowplot::plot_grid(plotlist = buoy_sst_3_plots[25:32],
                   ncol = 2,
                   nrow = 4)
```

<!-- Now document the years to keep for this buoy. Just visually look at figures and
keep those without any 'large gaps' in one
area; or rather, small gaps are okay if they are spread out. Quick for now, a
little subjective, can make more explicitly later if needed. -->
```{r buoys3keep, echo = FALSE, eval = FALSE}
buoy_sst_3_years_to_keep <- c(1991,
                              1996,
                              1999,
                              2000,
                              2002:2018,
                              2020:2031,
                              2023)

buoy_sst_3_mean_keep <- filter(buoy_sst_3_mean,
                               year %in% buoy_sst_3_years_to_keep)
buoy_sst_3_mean_not_keep <- filter(buoy_sst_3_mean,
                                   !(year %in% buoy_sst_3_years_to_keep))

# Keeping these:
buoy_sst_3_mean_keep %>% a()

# Not keeping these:
buoy_sst_3_mean_not_keep %>% a()

plot(buoy_sst_3_mean$year,
     buoy_sst_3_mean$sst_average,
     type = "o",
     main = "Black - all; red - years keeping")

points(buoy_sst_3_mean_keep$year,
       buoy_sst_3_mean_keep$sst_average,
       type = "o",
       col = "red")
```
<!-- Shows that you can't simply just have a cut off based on `num_days`.
To add to the EDM input file: -->
```{r buoy3keep, echo = FALSE, eval = FALSE}
buoy_sst_3_mean_keep

buoy_sst_dellwood_input <-
  rename(buoy_sst_3_mean_keep,
         buoy_sst_dellwood = sst_average) %>%
  mutate(return_year = year + 2)

buoy_sst_dellwood_input
tail(buoy_sst_dellwood_input)


```
